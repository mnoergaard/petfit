---
title: "Reference TAC Report"
output:
  html_document:
    toc: true
    toc_depth: 2
    code_folding: hide
params:
  analysis_folder: NULL
  bids_dir: NULL
  blood_dir: NULL
---

<!-- For temporary debugging, this defines temporary parameters for the parameterised report -->

```{r}
analysis_folder <- "/home/granville/Repositories/OpenNeuro/Demo/ds004869/derivatives/petfit/Secondary_Analysis/"
bids_dir <- "/home/granville/Repositories/OpenNeuro/Demo/ds004869/"
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(kinfitr)
library(knitr)
library(jsonlite)
library(plotly)
library(crosstalk)
library(htmltools)
library(scales)

theme_set(theme_light())

# Use parameters (from params or debugging section above)
analysis_folder <- params$analysis_folder %||% analysis_folder
bids_dir <- params$bids_dir %||% NULL

# Load configuration from standard location
config_path <- file.path(analysis_folder, "desc-petfitoptions_config.json")
config <- NULL
if (file.exists(config_path)) {
  tryCatch({
    config <- jsonlite::fromJSON(config_path)
    # cat("Loaded config from:", config_path, "\n")
  }, error = function(e) {
    cat("Warning: Could not load config file:", e$message, "\n")
  })
} else {
  cat("Config file not found at:", config_path, "\n")
}
```

This report summarises the reference TAC preparation step.

# Analysis Configuration

**Analysis folder:** `r params$analysis_folder`

**Generated on:** `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

# Reference TAC Configuration

```{r reference-config}
if (!is.null(config$ReferenceTAC)) {
  ref_tac <- config$ReferenceTAC

  # Method mapping for display
  fitting_method_display <- switch(ref_tac$fitting_method %||% "raw",
    "raw" = "Raw Reference TAC (no fitting)",
    "feng1tc" = "Feng+1TC Reference Model",
    "spline" = "Spline Model",
    "Unknown method"
  )

  # Weighting method display
  weights_method_display <- switch(ref_tac$weights_method %||% "same_as_target",
    "same_as_target" = "Same weights as target TACs",
    "0" = "0. Uniform (all weights = 1)",
    "1" = "1. frame_dur / tac_uncor",
    "2" = "2. sqrt(frame_dur * tac_uncor)",
    "3" = "3. sqrt(frame_dur) / tac",
    "4" = "4. sqrt(frame_dur)",
    "5" = "5. frame_dur * exp(-ln(2)/halflife)",
    "6" = "6. frame_dur / tac",
    "7" = "7. frame_dur",
    "8" = "8. frame_dur^2 / tac_uncor",
    "9" = "9. (frame_dur^2 / (frame_dur * tac)) * corrections^2",
    "custom" = "Custom formula",
    "Unknown method"
  )

  # Build configuration items list
  config_items <- list(
    "Reference Region" = ref_tac$region %||% "Not specified",
    "Fitting Method" = fitting_method_display
  )

  # Add noise approximation for raw method
  if ((ref_tac$fitting_method %||% "raw") == "raw") {
    noise_approx <- ref_tac$noise_approximation %||% FALSE
    if (!is.logical(noise_approx) || noise_approx == "") {
      noise_approx <- FALSE
    }
    config_items[["Noise Approximation"]] <- ifelse(noise_approx, "Yes (spline-based)", "No")
  }

  # Add spline df for spline method
  if ((ref_tac$fitting_method %||% "raw") == "spline") {
    config_items[["Spline Degrees of Freedom"]] <- ref_tac$spline_df %||% "Not specified"
  }

  # Add weighting info for fitted methods
  if ((ref_tac$fitting_method %||% "raw") != "raw") {
    config_items[["Reference Weighting Method"]] <- weights_method_display

    if ((ref_tac$weights_method %||% "same_as_target") == "custom") {
      config_items[["Custom Formula"]] <- ref_tac$weights_custom_formula %||% "Not specified"
    } else if ((ref_tac$weights_method %||% "same_as_target") != "same_as_target") {
      config_items[["Weights Formula"]] <- ref_tac$weights_formula %||% "Not specified"
    }

    if ((ref_tac$weights_method %||% "same_as_target") != "same_as_target" &&
        !is.null(ref_tac$weights_minweight) && ref_tac$weights_minweight != "") {
      config_items[["Minimum Weight"]] <- ref_tac$weights_minweight
    }
  }

  config_df <- tibble(
    Parameter = names(config_items),
    Value = map_chr(config_items, as.character)
  )

  kable(config_df, caption = "Reference TAC Configuration")

} else {
  cat("No reference TAC configuration found in the analysis file.")
}
```

```{r setup-conditions, echo=FALSE}
# Set up conditional execution based on reference TAC method
fitting_method <- config$ReferenceTAC$fitting_method %||% "raw"
noise_approximation <- config$ReferenceTAC$noise_approximation %||% FALSE

# Convert empty string to FALSE for backward compatibility
if (!is.logical(noise_approximation) || noise_approximation == "") {
  noise_approximation <- FALSE
}

# Define execution conditions
use_raw_refs <- fitting_method == "raw"
use_feng1tc <- fitting_method == "feng1tc"
use_spline <- fitting_method == "spline"
do_noise_approx <- use_raw_refs && noise_approximation
```


# Loading Data

## Loading TAC Data

```{r load-tacs}
tacs_files <- list.files(analysis_folder,
                        pattern = "*_desc-combinedregions_tacs.tsv",
                        recursive = TRUE)

if (length(tacs_files) == 0) {
  stop("No TAC files found in analysis folder: ", analysis_folder)
}

tac_data <- tibble(
  filename = tacs_files) %>%
  mutate(basename = basename(filename)) %>%
  mutate(attributes = map(filename, kinfitr:::bids_filename_attributes)) %>%
  unnest(attributes) %>%
  group_by(filename) %>%
  mutate(tacs = map(filename, ~read_tsv(file.path(analysis_folder, .x), show_col_types = FALSE))) %>%
  ungroup() %>%
  unnest(tacs) %>%
  select(-basename, -measurement, -desc)
```


## Extract Reference Region

```{r extract-reference, results='asis'}
ref_region_name <- config$ReferenceTAC$region %||% ""

if (ref_region_name == "") {
  stop("No reference region specified in configuration")
}

# Check if reference region exists in data
available_regions <- unique(tac_data$region)

if (!ref_region_name %in% available_regions) {
  stop("Reference region '", ref_region_name, "' not found in data. Available regions: ",
       paste(available_regions, collapse = ", "))
}

unique_pets <- length(unique(tac_data$pet))

pet_with_refs <- tac_data %>% 
  filter(region == ref_region_name) %>% 
  filter(!duplicated(pet)) %>% 
  pull(pet) %>% 
  length()

str_glue("Reference region **{ref_region_name}** found for {pet_with_refs} of {unique_pets} PET measurements.")
```


```{r}
ref_tac_data <- tac_data %>% 
  filter(region == ref_region_name) %>% 
  select(-filename, -region) %>% 
  rename(RefTAC = TAC)

target_tac_data <- tac_data %>% 
  filter(region != ref_region_name) %>% 
  select(-filename)
```


# Reference Weights Calculation

```{r setup-ref-weights-conditions, echo=FALSE}
# Determine if we need to calculate reference weights
# Only needed for fitted methods (feng1tc, spline) and when not using same weights as target
calculate_ref_weights <- (fitting_method %in% c("feng1tc", "spline")) &&
                         ((config$ReferenceTAC$weights_method %||% "same_as_target") != "same_as_target")

use_custom_ref_weights <- calculate_ref_weights &&
                          ((config$ReferenceTAC$weights_method %||% "same_as_target") == "custom")
use_defined_ref_weights <- calculate_ref_weights &&
                           ((config$ReferenceTAC$weights_method %||% "same_as_target") != "custom")
```

```{r, eval=calculate_ref_weights, echo=calculate_ref_weights, results='asis'}
str_glue("## Reference Region Weighting

Calculating weights for the reference region fitting using method: **{config$ReferenceTAC$weights_formula %||% 'Not specified'}**")
```

```{r load-weight-files, eval=calculate_ref_weights, echo=calculate_ref_weights}
# Load existing weight files created by weights_report.Rmd
weight_files <- list.files(analysis_folder,
                          pattern = "*_desc-weights_weights.tsv",
                          recursive = TRUE,
                          full.names = TRUE)

if (length(weight_files) == 0) {
  stop("No weight files found. Please run the weights calculation step first.")
}

# Read weight files and extract TAC data
ref_weights_tacdata <- tibble(
  filename = weight_files) %>%
  mutate(basename = basename(filename)) %>%
  mutate(weight_data = map(filename, ~read_tsv(.x, show_col_types = FALSE))) %>%
  unnest(weight_data) %>%
  select(pet, frame_start, frame_end, frame_dur, frame_mid, TAC)
```

```{r ref-weights-radioisotope, eval=calculate_ref_weights, echo=calculate_ref_weights}
# Extract radioisotope and halflife from Weights config (inherited from target weights)
radioisotope <- config$Weights$radioisotope %||% "C11"
halflife_raw <- config$Weights$halflife %||% ""

# Convert empty strings back to NULL for function calls
halflife <- if(halflife_raw == "" || is.null(halflife_raw)) NULL else as.numeric(halflife_raw)

# Prepare radioisotope and half-life
if (radioisotope == "Other" && !is.null(halflife)) {
  radionuclide_halflife <- halflife
  radioisotope_for_uncorrection <- "C11"  # Use as placeholder, actual halflife will override
} else {
  radionuclide_halflife <- NULL
  radioisotope_for_uncorrection <- radioisotope
}
```

```{r ref-weights-custom-prep, eval=use_custom_ref_weights, echo=use_custom_ref_weights}
# Prepare data for custom weights calculation
ref_weights_data <- ref_weights_tacdata %>%
  rename(tac = TAC) %>%
  mutate(tac_uncor = decay_uncorrect(frame_start, frame_end, tac,
                                     radioisotope = radioisotope_for_uncorrection,
                                     radionuclide_halflife = radionuclide_halflife)) %>%
  mutate(corrections = tac_uncor/tac)
```

```{r gen-ref-weights-custom, eval=use_custom_ref_weights, echo=use_custom_ref_weights}
# Apply custom weight formula
apply_weight_formula <- function(data, formula_string) {
  data %>%
    mutate(calcweights = eval(parse(text = formula_string)))
}

ref_weights_output <- apply_weight_formula(ref_weights_data, config$ReferenceTAC$weights_formula) %>%
  select(-tac_uncor, -corrections) %>%
  rename(TAC = tac)
```

```{r minweight-ref-weights-custom, eval=use_custom_ref_weights, echo=use_custom_ref_weights}
# Apply post-processing for custom weights
minweight <- as.numeric(config$ReferenceTAC$weights_minweight %||% 0.25)

ref_weights_final <- ref_weights_output %>%
  mutate(
    ref_weights = {

      # Outlier protection for max weight
      maxweight <- max(calcweights, na.rm = TRUE)
      maxweights <- tail(calcweights[order(calcweights)], 5)
      if (min(maxweights, na.rm = TRUE) < 0.5 * maxweight) {
        maxweight <- median(maxweights)
      }

      # Normalize weights
      calcweights[calcweights > maxweight] <- maxweight
      calcweights <- calcweights / maxweight

      # Apply minweight correction
      minweights <- rep(minweight, length(calcweights))
      if (any(calcweights < minweights)) {
        min_calcweight <- min(calcweights[frame_dur != 0], na.rm = TRUE)
        calcweights <- calcweights - min_calcweight / (1 - min_calcweight)
        calcweights <- minweights + calcweights * (1 - minweights)
      }

      calcweights[frame_dur == 0] <- 0
      calcweights
    }
  ) %>%
  select(-calcweights)
```

```{r gen-ref-weights-defined, eval=use_defined_ref_weights, echo=use_defined_ref_weights}
# Use predefined weighting methods
if (as.numeric(config$ReferenceTAC$weights_method) == 0) {

  # Method 0 (uniform weights)
  ref_weights_output <- ref_weights_tacdata %>%
    mutate(ref_weights = 1)

} else {

  # Using pre-defined weighting methods
  ref_weights_output <- ref_weights_tacdata %>%
    mutate(ref_weights = weights_create(t_start = frame_start/60,
                                    t_end = frame_end/60,
                                    TAC,
                                    radioisotope = radioisotope_for_uncorrection,
                                    method = as.numeric(config$ReferenceTAC$weights_method),
                                    minweight = as.numeric(config$ReferenceTAC$weights_minweight %||% 0.25),
                                    radionuclide_halflife = radionuclide_halflife))

}

ref_weights_final <- ref_weights_output
```

```{r normalise-ref-weights, eval=calculate_ref_weights, echo=calculate_ref_weights}
# Normalise reference weights to mean 1
ref_weights_final <- ref_weights_final %>%
  group_by(pet) %>%
  mutate(ref_weights = ref_weights/mean(ref_weights)) %>%
  ungroup()
```


```{r, eval=!calculate_ref_weights && fitting_method != "raw", echo=FALSE, results='asis'}
str_glue("## Reference Region Weighting

Using the same weights as the target TACs for reference region fitting.")
```

```{r, eval=!calculate_ref_weights && fitting_method != "raw", echo=!calculate_ref_weights && fitting_method != "raw"}
weights_files <- list.files(analysis_folder,
                        pattern = "*_weights.tsv",
                        recursive = TRUE)

ref_weights_final <- tibble(
  filename = weights_files) %>%
  mutate(basename = basename(filename)) %>%
  mutate(attributes = map(filename, kinfitr:::bids_filename_attributes)) %>%
  unnest(attributes) %>%
  group_by(filename) %>%
  mutate(tacs = map(filename, ~read_tsv(file.path(analysis_folder, .x), show_col_types = FALSE))) %>%
  ungroup() %>%
  unnest(tacs) %>%
  select(-basename, -measurement, -desc, -TAC, -filename) %>% 
  rename(ref_weights = weights)


```


# Reference TAC Processing

```{r, eval=use_raw_refs, echo=use_raw_refs, results='asis'}
str_glue("## Raw Reference TAC

Using raw (unfitted) reference TAC for modelling.")
```

```{r raw-reference-processing, eval=use_raw_refs, echo=use_raw_refs}
# For raw reference TAC, we simply use the data as-is
# No fitting is performed
ref_tac_preddata <- ref_tac_data %>%
  group_by(across(intersect(colnames(.), c("sub", "ses", "trc", "rec", "task",
                                           "run", "pet", "filename")))) %>%
  nest(.key = "ref_tacs") %>%
  ungroup()
```


```{r, eval=do_noise_approx, echo=do_noise_approx, results='asis'}
str_glue("### Noise Approximation Analysis

Comparing noise levels in reference region to target regions using spline-based estimation. ",
"Here we can compare whether the reference region has much greater approximated noise compared ",
"to the target regions. We should be concerned with our reference region if the ",
"RSS Ratio consistently << 1, implying much more noise in the reference region.")
```


```{r noise-approximation, eval=do_noise_approx, echo=do_noise_approx, fig.height=6, fig.width=9}
weights_files <- list.files(analysis_folder,
                        pattern = "*_weights.tsv",
                        recursive = TRUE)

weights_data <- tibble(
  filename = weights_files) %>%
  mutate(basename = basename(filename)) %>%
  mutate(attributes = map(filename, kinfitr:::bids_filename_attributes)) %>%
  unnest(attributes) %>%
  group_by(filename) %>%
  mutate(tacs = map(filename, ~read_tsv(file.path(analysis_folder, .x), show_col_types = FALSE))) %>%
  ungroup() %>%
  unnest(tacs) %>%
  select(-basename, -measurement, -desc, -TAC, -filename)

ref_tac_data_noisecalc <- ref_tac_data %>% 
  inner_join(weights_data) %>% 
  group_by(across(intersect(colnames(.), c("sub", "ses", "trc", "rec", "task",
                                           "run", "pet", "filename")))) %>%
  nest(.key = "ref_tacs") %>% 
  mutate(splinefit = map(ref_tacs, ~spline_tac(t_tac   = .x$frame_mid/60,
                                               tac     = .x$RefTAC,
                                               weights = .x$weights))) %>% 
  mutate(RSS = map_dbl(splinefit, ~sum((weights(.x)/mean(weights(.x))) * 
                                         (.x$tacs$TAC_fitted - .x$tacs$TAC)^2)))

target_tac_data_noisecalc <- target_tac_data %>% 
  inner_join(weights_data) %>% 
  group_by(across(intersect(colnames(.), c("sub", "ses", "trc", "rec", "task",
                                           "run", "pet", "filename", "region")))) %>%
  nest(.key = "target_tacs") %>% 
  mutate(splinefit = map(target_tacs, ~spline_tac(t_tac   = .x$frame_mid/60,
                                                  tac     = .x$TAC,
                                                  weights = .x$weights))) %>% 
  mutate(RSS = map_dbl(splinefit, ~sum((weights(.x)/mean(weights(.x))) * 
                                         (.x$tacs$TAC_fitted - .x$tacs$TAC)^2)))

RSS_compare <- ref_tac_data_noisecalc %>% 
  select(-ref_tacs, -splinefit) %>% 
  rename(RSS_Ref = RSS) %>% 
  inner_join(target_tac_data_noisecalc %>% select(-target_tacs, -splinefit)) %>% 
  mutate(RSS_Ratio = RSS / RSS_Ref)


ggplot(RSS_compare,
       aes(x=region, y=RSS_Ratio, colour=region)) + 
  ggbeeswarm::geom_beeswarm(cex=2) +
  geom_hline(yintercept=1, linetype="dashed") +
  labs(x = "Region",
       y = "RSS Ratio",
       colour = "Region") +
  scale_y_log10()
```


```{r, eval=use_feng1tc, echo=use_feng1tc, results='asis'}
str_glue("## Feng+1TC Reference Model Fitting

Fitting reference TAC using Feng arterial input function combined with one-tissue compartment model.")
```

```{r feng1tc-fitting, eval=use_feng1tc, echo=use_feng1tc}
ref_tac_fitdata <- ref_tac_data %>% 
  inner_join(ref_weights_final) %>% 
  group_by(across(intersect(colnames(.), c("sub", "ses", "trc", "rec", "task",
                                           "run", "pet")))) %>%
  nest(.key = "ref_tacs") 

ref_tac_fitdata <- ref_tac_fitdata %>%
  mutate(ref_fit = map(ref_tacs, ~feng_1tc_tac(t_tac   = .x$frame_mid/60,
                                              tac     = .x$RefTAC,
                                              weights = .x$ref_weights)))

ref_tac_preddata <- ref_tac_fitdata %>%
  mutate(ref_preds = map(ref_fit, ~.x$tacs %>%
                          rename(frame_mid = Time,
                                 RefTAC = Reference,
                                 RefTAC_fitted = Reference_fitted) %>%
                           mutate(frame_mid = frame_mid*60))) %>%
  select(-ref_fit) %>%
  mutate(ref_tacs = map2(ref_tacs, ref_preds, inner_join)) %>%
  mutate(ref_tacs = map(ref_tacs, ~.x %>%
                          select(-any_of("TAC")) %>%
                          rename(RefTAC_original = RefTAC,
                                 RefTAC = RefTAC_fitted,
                                 RefTAC_weights = ref_weights))) %>%
  select(-ref_preds) %>%
  mutate(ref_tacs_json = map(1:n(), ~list(RefTAC = "Modelled reference TAC",
                                  RefTAC_original = "Original reference TAC",
                                  RefTAC_weights = "Weights used for reference TAC fitting")))

ref_tac_pardata <- ref_tac_fitdata %>% 
  mutate(ref_pars = map(ref_fit, "par")) %>% 
  select(-ref_fit)
```


```{r feng1tc-saving, eval=use_feng1tc, echo=use_feng1tc}

```



```{r, eval=use_feng1tc, echo=use_feng1tc, results='asis'}
str_glue("### Feng+1TC Reference Model Plots")
```

```{r feng1tc-plotting, eval=use_feng1tc, echo=use_feng1tc}
walk2(ref_tac_fitdata$ref_fit,
      ref_tac_fitdata$pet, 
      ~print(plot(.x) + labs(title = .y)))
```



```{r, eval=use_spline, echo=use_spline, results='asis'}
spline_df <- config$ReferenceTAC$spline_df %||% 5
str_glue("## Spline Model Fitting

Fitting reference TAC using smooth spline with **{spline_df}** degrees of freedom.")
```

```{r spline-fitting, eval=use_spline, echo=use_spline}
spline_df <- as.numeric(config$ReferenceTAC$spline_df %||% -1)

ref_tac_fitdata <- ref_tac_data %>% 
  inner_join(ref_weights_final) %>% 
  group_by(across(intersect(colnames(.), c("sub", "ses", "trc", "rec", "task",
                                           "run", "pet")))) %>%
  nest(.key = "ref_tacs") 

ref_tac_fitdata <- ref_tac_fitdata %>%
  mutate(ref_fit = map(ref_tacs, ~spline_tac(t_tac   = .x$frame_mid/60,
                                              tac     = .x$RefTAC,
                                              weights = .x$ref_weights)))

ref_tac_preddata <- ref_tac_fitdata %>%
  mutate(ref_preds = map(ref_fit, ~.x$tacs %>%
                          rename(frame_mid = Time,
                                 RefTAC = TAC,
                                 RefTAC_fitted = TAC_fitted) %>%
                           mutate(frame_mid = frame_mid*60))) %>%
  select(-ref_fit) %>%
  mutate(ref_tacs = map2(ref_tacs, ref_preds, inner_join)) %>%
  mutate(ref_tacs = map(ref_tacs, ~.x %>%
                          select(-any_of("TAC")) %>%
                          rename(RefTAC_original = RefTAC,
                                 RefTAC = RefTAC_fitted,
                                 RefTAC_weights = ref_weights))) %>%
  select(-ref_preds) %>%
  mutate(ref_tacs_json = map(1:n(), ~list(RefTAC = "Modelled reference TAC",
                                  RefTAC_original = "Original reference TAC",
                                  RefTAC_weights = "Weights used for reference TAC fitting")))

```


```{r, eval=use_spline, echo=use_spline, results='asis'}
str_glue("### Spline Reference Model Plots")
```

```{r spline-plotting, eval=use_spline, echo=use_spline}
walk2(ref_tac_fitdata$ref_fit,
      ref_tac_fitdata$pet, 
      ~print(plot(.x) + labs(title = .y)))
```



# Saving Outcomes

```{r save-reference-tacs}
save_files <- tac_data %>% 
  filter(!duplicated(filename)) %>% 
  mutate(filename_tsv = str_replace(filename,
                                "desc-combinedregions_tacs.tsv",
                                "desc-ref_tacs.tsv")) %>% 
  mutate(filename_json = str_replace(filename,
                                "desc-combinedregions_tacs.tsv",
                                "desc-ref_tacs.json")) %>% 
  select(-filename) %>% 
  select((intersect(colnames(.), c("sub", "ses", "trc", "rec", "task",
                                   "run", "pet", 
                                   "filename_tsv",
                                   "filename_json")))) %>% 
  inner_join(ref_tac_preddata)

save_files %>%
  pwalk(function(ref_tacs, filename_tsv, ...) {
    write_tsv(ref_tacs, 
              file = paste0(analysis_folder, "/", filename_tsv))
  })


save_files %>%
  pwalk(function(ref_tacs_json, filename_json, ...) {
    write_json(ref_tacs_json,
               path = paste0(analysis_folder, "/", filename_json),
               pretty=TRUE)
  })
```

## Updating Target TAC Files

The reference region is removed from the target TAC files so it is not used as a target region during model fitting.

```{r save-updated-target-tacs}
# Get target TACs (excluding reference region) with filename info
target_tac_files <- tac_data %>%
  filter(region != ref_region_name)

# Save updated combinedregions_tacs.tsv files (overwriting originals)
target_tac_files %>%
  group_by(filename) %>%
  group_walk(~{
    write_tsv(.x %>% select(-filename),
              file = paste0(analysis_folder, "/", .y$filename))
  })
```

---

# Session Information

```{r session-info}
sessionInfo()
```
